name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Regenerate lockfile with Nix's npm and compute hash
  prepare:
    runs-on: ubuntu-latest
    outputs:
      npm-hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Regenerate package-lock.json with Nix npm
        run: |
          # Use Nix's npm to regenerate lockfile for compatibility
          rm -rf node_modules package-lock.json
          nix develop .#ci --command npm install --package-lock-only
          echo "Lockfile regenerated with Nix npm version:"
          nix develop .#ci --command npm --version

      - name: Compute npm dependencies hash
        id: hash
        run: |
          HASH=$(nix run nixpkgs#prefetch-npm-deps -- package-lock.json 2>/dev/null)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Computed npm deps hash: $HASH"

      - name: Upload regenerated lockfile
        uses: actions/upload-artifact@v4
        with:
          name: package-lock
          path: package-lock.json
          retention-days: 1

  # Build and verify the application
  build:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: package-lock

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Update flake with npm hash
        run: |
          sed -i 's|npmDepsHash = "sha256-[^"]*";|npmDepsHash = "${{ needs.prepare.outputs.npm-hash }}";|' flake.nix
          cat flake.nix | grep npmDepsHash

      - name: Build application
        run: nix build --print-build-logs

      - name: Verify build output
        run: |
          ls -la result/
          ls -la result/lib/pbnj/
          test -f result/bin/pbnj-server
          echo "Build successful!"

  # Build OCI container image
  build-container:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: package-lock

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Update flake with npm hash
        run: |
          sed -i 's|npmDepsHash = "sha256-[^"]*";|npmDepsHash = "${{ needs.prepare.outputs.npm-hash }}";|' flake.nix
          cat flake.nix | grep npmDepsHash

      - name: Build container image
        run: nix build .#container --print-build-logs

      - name: Load and test container
        run: |
          docker load < result
          docker images | grep pbnj

          # Start container
          docker run -d --name pbnj-test \
            -e AUTH_KEY=test-key \
            -p 4321:4321 \
            pbnj:latest

          # Wait for server to be ready
          echo "Waiting for server..."
          for i in {1..30}; do
            if curl -s http://localhost:4321 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            sleep 1
          done

          # Show logs
          docker logs pbnj-test

          # Test health
          curl -f http://localhost:4321 || (docker logs pbnj-test && exit 1)

          # Cleanup
          docker stop pbnj-test
          docker rm pbnj-test

      - name: Save container image
        run: docker save pbnj:latest | gzip > pbnj-container.tar.gz

      - name: Upload container artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image
          path: pbnj-container.tar.gz
          retention-days: 7

  # Build for Cloudflare (parallel path)
  build-cloudflare:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build for Cloudflare
        run: |
          nix develop .#ci --command bash -c "npm ci && npm run build:cloudflare"
          echo "Cloudflare build successful!"
          ls -la dist/

  # Push container to GitHub Container Registry (main branch only)
  push-container:
    runs-on: ubuntu-latest
    needs: build-container
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: container-image

      - name: Load container image
        run: |
          gunzip -c pbnj-container.tar.gz | docker load
          docker images | grep pbnj

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push container image
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/pbnj"

          docker tag pbnj:latest "${IMAGE_NAME}:latest"
          docker tag pbnj:latest "${IMAGE_NAME}:${{ github.sha }}"

          docker push "${IMAGE_NAME}:latest"
          docker push "${IMAGE_NAME}:${{ github.sha }}"

          echo "Pushed:"
          echo "  - ${IMAGE_NAME}:latest"
          echo "  - ${IMAGE_NAME}:${{ github.sha }}"

  # Deploy to Cloudflare (optional, main branch only)
  deploy-cloudflare:
    runs-on: ubuntu-latest
    needs: build-cloudflare
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: cloudflare
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then
            nix develop .#ci --command bash -c "npm ci && npm run deploy"
          else
            echo "Skipping Cloudflare deployment - secrets not configured"
          fi
